# 想定するIoTシステム
本開発環境が対象とするのは，IoT (Internet of Things)のうちセンサ系のシステムの一部である．
IoTとは，いままでネットワークに繋がっていなかった様々な装置をネットワークに接続することで，様々な
サービスを実現することを目的としたものである．

既に実用化されたシステムとしては，クラウド経由でエアコンや照明を制御(ON/OFF制御や予約)するもの，
お風呂の予約，冷蔵庫に入っている(と思われる推定値)ものを外出先から見るシステムなどがある．

一般のユーザの目に触れない範囲では，ビルの廊下や部屋に多数のセンサを配置して，温度・湿度，人の存在等を
検出して，エアコンや照明を制御するものもある．

本開発環境で開発の対象となるのは，センサ系のIoTシステムにおけるセンサを搭載した小型省電力の端末である．


## IoTのネットワーク
IoTのネットワークは，下図のような構成を取ることが多い．その理由として，センサを始めとした末端の端末は低価格，低消費電力を重要視するため，計算能力が低く，ネットワーク上の脅威に対抗するようなセキュリティ機能を持たせることができないため，専用ネットワークで他のユーザから切り離す．

また，各センサは測定結果を周期的に自分が接続しているネットワーク上のGW(ゲートウェイ)に送信し，データを預かってもらう．ゲートウェイはセンサ専用のネットワークとインターネットの両方に接続しており，インターネット側には強固なセキュリティを持たせる．

実際にユーザサービスを行うIoTのサーバは，任意のタイミングで末端のセンサのデータをゲートウェイに取得しに行く．

![IoTネットワーク](images/IoTネットワーク.png)

### センサネットワークの通信メディアとプロトコル
センサ専用ネットワークは有線・無線さまざま存在するが，ゲートウェイまでの距離や許される消費電力，電波的な規制などで選択されている．特に，無線はいろいろな種類が存在しているが，中には特定の事業者が運営するネットワークにお金を払って接続する必要があるものも存在する．

企業の業務における試作だけでなく，ホビーストや学生の実習などでも使うことを目的としているため，本開発環境では，TCP/IP(インターネットプロトコル)とイーサネット(有線)もしくはWiFi(無線)の組み合わせで構成するセンサネットワークを前提としている．

TCP/IPを用いるセンサネットワークにおいて，センサ端末からゲートウェイへのデータの送信に用いられるアプリケーションレベルのプロトコルは大きく分けて2種類存在する．
これは，一般的なwebアプリケーションと同じREST API (Representational State Transfer Application Programming Interface)とwebのプロトコルを軽量化したプロトコル(MQTTやCoAP)である．

本開発環境では，Arduino用のオープンソースの実装の有無，ゲートウェイとなる計算機で動作させるための，ソフトウェアパッケージの安定性や利用者数を考慮して，MQTTを採用している．

### MQTT(Message Queuing Telemetry Transport)
MQTTはIoT向けに設計されたプロトコルで，通信に保証のあるTCPベースで，下の図のパブリッシャーがIoTネットワークのセンサ端末，ブローカーがゲートウェイ上で動作するセンサデータを一時的に預かるソフトウェア．サブスクライバーはセンサデータを集めて何らかのサービスを行うIoTサーバ上で動作するサービスソフトウェアとなる．

センサは自分の測定結果にラベル(MQTTではトピックと呼ばれる)をつけて，ブローカーに送信する．IoTサーバはブローカーに接続した上で，自分が購読したいタグを申告する．

すると，サーバーが接続した時点以降に購読申請があったタグがついたメッセージをブローカーは，接続中&購読申告済みの全サーバに配信する．接続していないサーバに後から届ける等の機能はない．

MQTTでは，購読を制限したい場合に，アカウントを発行して特定のIoTサーバに対してのみ購読を許す等もできる．これも，ブローカーとサブスクライバーの間の話であり，センサ端末には影響しない．

[画像出典](https://developer.mamezou-tech.com/iot/internet-of-things-06/)
![MQTTイメージ](images/MQTT.png)

## 開発対象のセンサ端末
センサ端末は，周囲の環境の何かのデータを取得し，それをネットワーク上のサーバに送信するものであるが，大きく分けて
2つに分類できる．
最初は，常時測定を続けて，値が変化したらサーバに通知するもの．もう一つが決められた周期(30秒，1分など)で
測定し，値の変化に関係なく，測定結果をサーバに送信するものである．
この2種類のセンサ端末は目的に応じて使い分けがされるが，常時測定のものは消費電力が大きくなるため，
避けられる傾向にある．

このことから，本開発環境では，周期的に測定値をサーバにアップロードするタイプのセンサ端末を対象としている．



***

- [「マイコンとArduinoの概要」に進む](Arduino.md)
- [「README」に戻る](../README.md)